#!/bin/sh
#set -x
set -euo pipefail

cd "$(dirname "$0")"
cd ..
PROJECT_DIR="$(pwd)"
BUILD_DIR="$PROJECT_DIR/target/wix"

PACKAGE_NAME="tpnote"
BIN_NAME="tpnote"
BIN_VERSION="$(grep -e '^version' Cargo.toml | sed 's/.*\"\(.*\)\".*/\1/' | head -n 1)"

# Ensure build dir exists
mkdir -p "$BUILD_DIR"
cd "$BUILD_DIR"

# Enter the dev shell from the flake before running WiX
nix develop "$PROJECT_DIR/wix#default" --command \
  wine64 wix.exe build tpnote.wxs -b . -o "$PACKAGE_NAME-$BIN_VERSION-x86_64.msi"
